<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TabularAML Feature Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            gap: 20px;
        }
        
        .mode-btn {
            background: white;
            color: #667eea;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }
        
        .mode-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        
        .main-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .mode-panel {
            display: none;
        }
        
        .mode-panel.active {
            display: block;
        }
        
        .controls {
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-bottom: 1px solid #e0e0e0;
        }
        
        .control-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #555;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #667eea;
        }
        
        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group.wide {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
            font-size: 14px;
        }
        
        .form-group input, .form-group select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 8px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .progress-section {
            padding: 30px;
            display: none;
        }
        
        .progress-section.active {
            display: block;
        }
        
        .status-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .status-card.generation {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .status-card.features {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .status-card.score {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .status-card.stagnation {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        
        .status-card h3 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .status-card p {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .progress-bars {
            margin-bottom: 30px;
        }
        
        .progress-item {
            margin-bottom: 20px;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
        }
        
        .progress-fill.child-eval {
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .log-section {
            background: #1e1e1e;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-content {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #00ff00;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        
        .feature-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .feature-list h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .feature-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #667eea;
            font-size: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .feature-item.new {
            border-left-color: #43e97b;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .strategy-indicator {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 10px;
        }
        
        .strategy-normal {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .strategy-hopeful {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .strategy-beam {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .results-section {
            padding: 30px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: none;
        }
        
        .results-section.active {
            display: block;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .result-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .result-card h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .metric-value {
            font-weight: 600;
            color: #667eea;
        }
        
        .scrollbar-custom {
            scrollbar-width: thin;
            scrollbar-color: #667eea #f1f1f1;
        }
        
        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }
        
        .transform-results {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .download-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .file-drop-zone {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: #f9f9f9;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .file-drop-zone:hover, .file-drop-zone.dragover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 220px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🧠 TabularAML Feature Generator</h1>
            <p>Intelligent automated feature engineering with comprehensive controls</p>
        </div>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('train')">
                🚀 Train New Generator
            </button>
            <button class="mode-btn" onclick="switchMode('transform')">
                🔄 Load & Transform
            </button>
        </div>
        
        <div class="main-panel">
            <!-- TRAIN MODE -->
            <div class="mode-panel active" id="trainMode">
                <div class="controls">
                    <!-- Dataset Section -->
                    <div class="control-section">
                        <div class="section-title">📊 Dataset Configuration</div>
                        <div class="control-group">
                            <div class="form-group">
                                <label for="dataset">Dataset File</label>
                                <input type="file" id="dataset" accept=".csv,.json" />
                            </div>
                            <div class="form-group">
                                <label for="target">Target Column</label>
                                <select id="target">
                                    <option value="">Select target column...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="task">Task Type</label>
                                <select id="task">
                                    <option value="auto">Auto-detect</option>
                                    <option value="classification">Classification</option>
                                    <option value="regression">Regression</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generation Parameters -->
                    <div class="control-section">
                        <div class="section-title">🔧 Generation Parameters</div>
                        <div class="control-group">
                            <div class="form-group">
                                <label for="mode" class="tooltip">Generation Mode ℹ️
                                    <span class="tooltiptext">Preset configurations: Low (fast), Medium (balanced), Best (thorough), Extreme (maximum), None (use custom parameters)</span>
                                </label>
                                <select id="mode">
                                    <option value="medium">Medium</option>
                                    <option value="lite">Lite</option>
                                    <option value="best">Best</option>
                                    <option value="extreme">Extreme</option>
                                    <option value="none">None (Custom)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="generations" class="tooltip">Generations ℹ️
                                    <span class="tooltiptext">Number of evolutionary generations to run</span>
                                </label>
                                <input type="number" id="generations" placeholder="15" min="1" max="100" />
                            </div>
                            <div class="form-group">
                                <label for="parents" class="tooltip">Parents per Generation ℹ️
                                    <span class="tooltiptext">Number of parent features selected each generation</span>
                                </label>
                                <input type="number" id="parents" placeholder="40" min="5" max="200" />
                            </div>
                            <div class="form-group">
                                <label for="children" class="tooltip">Children per Generation ℹ️
                                    <span class="tooltiptext">Number of candidate features generated each generation</span>
                                </label>
                                <input type="number" id="children" placeholder="200" min="10" max="1000" />
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Parameters -->
                    <div class="control-section">
                        <div class="section-title">⚙️ Advanced Parameters</div>
                        <div class="control-group">
                            <div class="form-group">
                                <label for="min_pct_gain" class="tooltip">Min Percentage Gain ℹ️
                                    <span class="tooltiptext">Minimum improvement required to keep a feature</span>
                                </label>
                                <input type="number" id="min_pct_gain" placeholder="0.001" min="0.0001" max="0.1" step="0.0001" />
                            </div>
                            <div class="form-group">
                                <label for="early_stop_iter" class="tooltip">Early Stop Iterations ℹ️
                                    <span class="tooltiptext">Early stopping as fraction of total generations (e.g. 0.4 = 40% of generations)</span>
                                </label>
                                <input type="number" id="early_stop_iter" placeholder="0.4" min="0.1" max="1" step="0.1" />
                            </div>
                            <div class="form-group">
                                <label for="early_stop_child" class="tooltip">Early Stop Child Eval ℹ️
                                    <span class="tooltiptext">Fraction of candidates to evaluate before early stopping</span>
                                </label>
                                <input type="number" id="early_stop_child" placeholder="0.3" min="0.01" max="1" step="0.01" />
                            </div>
                            <div class="form-group">
                                <label for="max_new_feats" class="tooltip">Max New Features ℹ️
                                    <span class="tooltiptext">Maximum number of new features to generate (leave empty for unlimited)</span>
                                </label>
                                <input type="number" id="max_new_feats" placeholder="Unlimited" min="1" max="1000" />
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="form-group">
                                <label for="ranking_method" class="tooltip">Ranking Method ℹ️
                                    <span class="tooltiptext">Method for ranking feature importance</span>
                                </label>
                                <select id="ranking_method">
                                    <option value="multi_criteria">Multi-Criteria</option>
                                    <option value="shap">SHAP</option>
                                    <option value="none">None</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="cv_folds" class="tooltip">CV Folds ℹ️
                                    <span class="tooltiptext">Number of cross-validation folds</span>
                                </label>
                                <input type="number" id="cv_folds" placeholder="5" min="2" max="20" />
                            </div>
                            <div class="form-group">
                                <label for="time_budget" class="tooltip">Time Budget (minutes) ℹ️
                                    <span class="tooltiptext">Maximum time to run (leave empty for no limit)</span>
                                </label>
                                <input type="number" id="time_budget" placeholder="No limit" min="1" max="1440" />
                            </div>
                            <div class="form-group">
                                <label for="save_path" class="tooltip">Save Path ℹ️
                                    <span class="tooltiptext">Where to save the trained generator (optional)</span>
                                </label>
                                <input type="text" id="save_path" placeholder="cache/feature_generator.pkl" />
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="use_gpu" checked />
                                    <label for="use_gpu" class="tooltip">Use GPU ℹ️
                                        <span class="tooltiptext">Enable GPU acceleration if available</span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="adaptive" checked />
                                    <label for="adaptive" class="tooltip">Adaptive Mode ℹ️
                                        <span class="tooltiptext">Enable adaptive parameter adjustment</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="startGeneration()">
                            🚀 Start Feature Generation
                        </button>
                        <button class="btn btn-success" onclick="saveGenerator()" id="saveBtn" disabled>
                            💾 Save Generator
                        </button>
                    </div>
                </div>
                
                <div class="progress-section" id="progressSection">
                    <div class="status-cards">
                        <div class="status-card generation">
                            <h3 id="currentGen">0</h3>
                            <p>Current Generation</p>
                        </div>
                        <div class="status-card features">
                            <h3 id="totalFeatures">0</h3>
                            <p>Total Features</p>
                        </div>
                        <div class="status-card score">
                            <h3 id="bestScore">0.000</h3>
                            <p>Best Score</p>
                        </div>
                        <div class="status-card stagnation">
                            <h3 id="stagnationLevel">NONE</h3>
                            <p>Stagnation Level</p>
                        </div>
                    </div>
                    
                    <div class="progress-bars">
                        <div class="progress-item">
                            <div class="progress-label">
                                <span>Generation Progress <span id="strategyIndicator" class="strategy-indicator strategy-normal">Normal</span></span>
                                <span id="genProgress">0/15</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="genProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="progress-item">
                            <div class="progress-label">
                                <span>Child Evaluation Progress</span>
                                <span id="childProgress">0/0 - Selected: 0</span>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill child-eval" id="childProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="log-section scrollbar-custom">
                        <div class="log-content" id="logContent">
                            [INFO] Feature generation initialized...\n
                        </div>
                    </div>
                    
                    <div class="feature-list">
                        <h3>Generated Features</h3>
                        <div class="feature-grid" id="featureGrid">
                            <!-- Features will be added dynamically -->
                        </div>
                    </div>
                </div>
                
                <div class="results-section" id="resultsSection">
                    <h2 style="margin-bottom: 20px; text-align: center;">🎉 Generation Complete!</h2>
                    <div class="results-grid">
                        <div class="result-card">
                            <h3>📊 Performance Metrics</h3>
                            <div class="metric-item">
                                <span>Initial Score:</span>
                                <span class="metric-value" id="initialScore">0.000</span>
                            </div>
                            <div class="metric-item">
                                <span>Final Score:</span>
                                <span class="metric-value" id="finalScore">0.000</span>
                            </div>
                            <div class="metric-item">
                                <span>Improvement:</span>
                                <span class="metric-value" id="improvement">+0.000</span>
                            </div>
                            <div class="metric-item">
                                <span>Percentage Gain:</span>
                                <span class="metric-value" id="percentGain">+0.00%</span>
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h3>⚡ Generation Stats</h3>
                            <div class="metric-item">
                                <span>Total Time:</span>
                                <span class="metric-value" id="totalTime">0.00s</span>
                            </div>
                            <div class="metric-item">
                                <span>Generations:</span>
                                <span class="metric-value" id="completedGens">0</span>
                            </div>
                            <div class="metric-item">
                                <span>Features Added:</span>
                                <span class="metric-value" id="featuresAdded">0</span>
                            </div>
                            <div class="metric-item">
                                <span>Total Restarts:</span>
                                <span class="metric-value" id="totalRestarts">0</span>
                            </div>
                        </div>
                        
                        <div class="result-card">
                            <h3>🎯 Strategy Performance</h3>
                            <div class="metric-item">
                                <span>Normal Strategy:</span>
                                <span class="metric-value" id="normalSuccess">0.00</span>
                            </div>
                            <div class="metric-item">
                                <span>Hopeful Monster:</span>
                                <span class="metric-value" id="hopefulSuccess">0.00</span>
                            </div>
                            <div class="metric-item">
                                <span>Beam Search:</span>
                                <span class="metric-value" id="beamSuccess">0.00</span>
                            </div>
                            <div class="metric-item">
                                <span>Best Generation:</span>
                                <span class="metric-value" id="bestGeneration">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-info" onclick="resetInterface()">
                            🔄 Generate New Features
                        </button>
                        <button class="btn btn-success" onclick="saveGenerator()">
                            💾 Save This Generator
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- TRANSFORM MODE -->
            <div class="mode-panel" id="transformMode">
                <div class="controls">
                    <div class="control-section">
                        <div class="section-title">📁 Load Saved Generator</div>
                        <div class="control-group wide">
                            <div class="form-group">
                                <label for="generatorFile">Saved Generator File (.pkl)</label>
                                <input type="file" id="generatorFile" accept=".pkl" />
                            </div>
                            <div class="form-group">
                                <label for="transformDataset">Dataset to Transform</label>
                                <input type="file" id="transformDataset" accept=".csv,.json" />
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-info" onclick="loadGenerator()">
                                📥 Load Generator
                            </button>
                            <button class="btn btn-primary" onclick="transformData()" id="transformBtn" disabled>
                                🔄 Transform Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="transform-results" id="transformResults" style="display: none;">
                        <h3>✨ Transformation Results</h3>
                        <div id="transformInfo"></div>
                        <button class="download-btn" onclick="downloadTransformed()" id="downloadBtn" style="display: none;">
                            📥 Download Transformed Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        let currentMode = 'train';
        let savedGeneratorData = null;
        let transformedData = null;
        
        // Global state
        let generationState = {
            isRunning: false,
            currentGen: 0,
            totalGens: 0,
            currentChildEval: 0,
            totalChildEval: 0,
            selectedCount: 0,
            features: [],
            logs: [],
            startTime: null,
            strategy: 'normal',
            stagnationLevel: 'NONE'
        };

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            
            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update panels
            document.querySelectorAll('.mode-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(mode + 'Mode').classList.add('active');
        }

        // Dynamic placeholder updates based on mode (loaded from server)
        let modePresets = {};

        async function loadModePresets() {
            try {
                const response = await fetch('/get_mode_presets');
                const data = await response.json();
                modePresets = data;
                console.log('📊 Loaded mode presets:', modePresets);
                updatePlaceholders(); // Update placeholders after loading
            } catch (error) {
                console.error('❌ Failed to load mode presets:', error);
                // Fallback to defaults if server fails
                modePresets = {
                    'none': { generations: 15, parents: 40, children: 200, early_stop_child: 0.3, early_stop_iter: 0.4, min_pct_gain: 0.001, cv_folds: 5, time_budget: '' }
                };
            }
        }

        function updatePlaceholders() {
            const selectedMode = document.getElementById('mode').value;
            const presets = modePresets[selectedMode] || modePresets['none'] || {};
            
            // Update placeholders for all mode-affected parameters
            Object.keys(presets).forEach(param => {
                const element = document.getElementById(param);
                if (element) {
                    element.placeholder = presets[param];
                }
            });
        }

        // Load presets and setup event handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Load presets from server
            loadModePresets();
            
            // Setup mode change handler
            const modeSelect = document.getElementById('mode');
            if (modeSelect) {
                modeSelect.addEventListener('change', updatePlaceholders);
            }
        });

        // Socket event handlers
        socket.on('connect', function() {
            console.log('✅ Connected to FeatureGenerator server');
            addLogMessage('Connected to server - ready for comprehensive feature generation!');
        });

        socket.on('disconnect', function() {
            console.log('❌ Disconnected from server');
            addLogMessage('Disconnected from server');
        });

        socket.on('progress_update', function(data) {
            console.log('📊 Progress update:', data);
            if (data.type === 'generation') {
                updateGenerationProgress(data.current, data.total);
            } else if (data.type === 'child_eval') {
                updateChildProgress(data.evaluated, data.total, data.selected);
            }
        });
        
        socket.on('log_update', function(data) {
            console.log('📝 Log:', data.message);
            const logContent = document.getElementById('logContent');
            logContent.textContent += data.message + '\n';
            logContent.scrollTop = logContent.scrollHeight;
        });
        
        socket.on('feature_count_update', function(data) {
            console.log('✨ Feature count:', data.count);
            updateFeatureCount(data.count);
        });
        
        socket.on('score_update', function(data) {
            console.log('📈 Score update:', data.score);
            updateBestScore(data.score);
        });
        
        socket.on('stagnation_update', function(data) {
            console.log('⚠️ Stagnation:', data.level);
            updateStagnationLevel(data.level);
        });
        
        socket.on('strategy_update', function(data) {
            console.log('🎯 Strategy:', data.strategy);
            updateStrategy(data.strategy);
        });
        
        socket.on('generation_complete', function(data) {
            console.log('🎉 Generation complete!', data);
            generationState.isRunning = false;
            document.querySelector('.btn-primary').disabled = false;
            document.getElementById('saveBtn').disabled = false;
            savedGeneratorData = data.generator_data;
            showResults(data.results);
        });
        
        socket.on('save_complete', function(data) {
            console.log('💾 Save complete:', data);
            alert(`Generator saved successfully to: ${data.path}`);
        });
        
        socket.on('transform_complete', function(data) {
            console.log('🔄 Transform complete:', data);
            showTransformResults(data);
        });
        
        socket.on('error', function(data) {
            console.error('❌ Server error:', data.message);
            addLogMessage('ERROR: ' + data.message);
            generationState.isRunning = false;
            document.querySelector('.btn-primary').disabled = false;
        });

        // UI Update functions
        function updateGenerationProgress(current, total) {
            generationState.currentGen = current;
            generationState.totalGens = total;
            
            document.getElementById('currentGen').textContent = current;
            document.getElementById('genProgress').textContent = `${current}/${total}`;
            
            const progress = (current / total) * 100;
            document.getElementById('genProgressBar').style.width = `${progress}%`;
        }

        function updateChildProgress(evaluated, total, selected) {
            generationState.currentChildEval = evaluated;
            generationState.totalChildEval = total;
            generationState.selectedCount = selected;
            
            document.getElementById('childProgress').textContent = 
                `${evaluated}/${total} - Selected: ${selected}`;
            
            const progress = total > 0 ? (evaluated / total) * 100 : 0;
            document.getElementById('childProgressBar').style.width = `${progress}%`;
        }

        function updateFeatureCount(count) {
            document.getElementById('totalFeatures').textContent = count;
        }

        function updateBestScore(score) {
            document.getElementById('bestScore').textContent = score.toFixed(5);
        }

        function updateStagnationLevel(level) {
            generationState.stagnationLevel = level;
            document.getElementById('stagnationLevel').textContent = level;
        }

        function updateStrategy(strategy) {
            generationState.strategy = strategy;
            const indicator = document.getElementById('strategyIndicator');
            indicator.textContent = strategy.charAt(0).toUpperCase() + strategy.slice(1);
            
            indicator.className = 'strategy-indicator';
            if (strategy === 'hopeful_monster') {
                indicator.classList.add('strategy-hopeful');
            } else if (strategy === 'beam_search') {
                indicator.classList.add('strategy-beam');
            } else {
                indicator.classList.add('strategy-normal');
            }
        }

        function addLogMessage(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            const logContent = document.getElementById('logContent');
            logContent.textContent += logEntry + '\n';
            logContent.scrollTop = logContent.scrollHeight;
        }

        function showResults(results = {}) {
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('resultsSection').classList.add('active');
            
            // Update with real results
            if (results.total_time) document.getElementById('totalTime').textContent = results.total_time + 's';
            if (results.completed_gens) document.getElementById('completedGens').textContent = results.completed_gens;
            if (results.features_added) document.getElementById('featuresAdded').textContent = results.features_added;
            if (results.initial_score) document.getElementById('initialScore').textContent = results.initial_score.toFixed(5);
            if (results.final_score) document.getElementById('finalScore').textContent = results.final_score.toFixed(5);
            if (results.improvement) document.getElementById('improvement').textContent = (results.improvement > 0 ? '+' : '') + results.improvement.toFixed(5);
            if (results.percent_gain) document.getElementById('percentGain').textContent = (results.percent_gain > 0 ? '+' : '') + results.percent_gain.toFixed(2) + '%';
            if (results.total_restarts) document.getElementById('totalRestarts').textContent = results.total_restarts;
            if (results.best_generation) document.getElementById('bestGeneration').textContent = results.best_generation;
        }

        function showTransformResults(data) {
            const resultsDiv = document.getElementById('transformResults');
            const infoDiv = document.getElementById('transformInfo');
            
            infoDiv.innerHTML = `
                <p><strong>Original features:</strong> ${data.original_features}</p>
                <p><strong>Transformed features:</strong> ${data.transformed_features}</p>
                <p><strong>Features added:</strong> ${data.features_added}</p>
                <p><strong>Transformation time:</strong> ${data.transform_time}s</p>
            `;
            
            transformedData = data.transformed_data;
            resultsDiv.style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'inline-block';
        }

        function resetInterface() {
            generationState = {
                isRunning: false,
                currentGen: 0,
                totalGens: 0,
                currentChildEval: 0,
                totalChildEval: 0,
                selectedCount: 0,
                features: [],
                logs: [],
                startTime: null,
                strategy: 'normal',
                stagnationLevel: 'NONE'
            };
            
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('resultsSection').classList.remove('active');
            document.querySelector('.btn-primary').disabled = false;
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('logContent').textContent = '[INFO] Ready for comprehensive feature generation...\n';
            document.getElementById('featureGrid').innerHTML = '';
            
            updateGenerationProgress(0, 15);
            updateChildProgress(0, 0, 0);
            updateFeatureCount(0);
            updateBestScore(0);
            updateStagnationLevel('NONE');
            updateStrategy('normal');
        }

        // Generation functions
        async function startGeneration() {
            console.log('🚀 Starting comprehensive feature generation...');
            const startBtn = document.querySelector('.btn-primary');
            startBtn.disabled = true;
            
            generationState.isRunning = true;
            generationState.startTime = new Date();
            
            // Show progress section
            document.getElementById('progressSection').classList.add('active');
            
            // Collect all parameters
            const formData = new FormData();
            const fileInput = document.getElementById('dataset');
            if (fileInput.files[0]) {
                formData.append('dataset', fileInput.files[0]);
            }
            
            // Basic parameters
            formData.append('target', document.getElementById('target').value);
            formData.append('task', document.getElementById('task').value);
            formData.append('mode', document.getElementById('mode').value);
            formData.append('generations', document.getElementById('generations').value);
            formData.append('parents', document.getElementById('parents').value);
            formData.append('children', document.getElementById('children').value);
            
            // Advanced parameters
            formData.append('min_pct_gain', document.getElementById('min_pct_gain').value);
            formData.append('early_stop_iter', document.getElementById('early_stop_iter').value);
            formData.append('early_stop_child', document.getElementById('early_stop_child').value);
            formData.append('max_new_feats', document.getElementById('max_new_feats').value || '');
            formData.append('ranking_method', document.getElementById('ranking_method').value);
            formData.append('cv_folds', document.getElementById('cv_folds').value);
            formData.append('time_budget', document.getElementById('time_budget').value || '');
            formData.append('save_path', document.getElementById('save_path').value || '');
            formData.append('use_gpu', document.getElementById('use_gpu').checked);
            formData.append('adaptive', document.getElementById('adaptive').checked);
            
            try {
                const response = await fetch('/start_generation', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to start generation');
                }
                
                addLogMessage('🚀 Comprehensive FeatureGenerator started with all parameters!');
                console.log('✅ Generation started successfully');
            } catch (error) {
                console.error('❌ Start generation error:', error);
                addLogMessage('Error: ' + error.message);
                startBtn.disabled = false;
                generationState.isRunning = false;
            }
        }

        async function saveGenerator() {
            if (!savedGeneratorData) {
                alert('No generator to save. Please complete a generation first.');
                return;
            }
            
            const savePath = document.getElementById('save_path').value || 'cache/feature_generator.pkl';
            
            try {
                const response = await fetch('/save_generator', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        save_path: savePath
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to save generator');
                }
                
                console.log('✅ Generator saved successfully');
            } catch (error) {
                console.error('❌ Save error:', error);
                alert('Error saving generator: ' + error.message);
            }
        }

        async function loadGenerator() {
            const fileInput = document.getElementById('generatorFile');
            if (!fileInput.files[0]) {
                alert('Please select a generator file first.');
                return;
            }
            
            const formData = new FormData();
            formData.append('generator_file', fileInput.files[0]);
            
            try {
                const response = await fetch('/load_generator', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load generator');
                }
                
                document.getElementById('transformBtn').disabled = false;
                alert('Generator loaded successfully!');
                console.log('✅ Generator loaded');
            } catch (error) {
                console.error('❌ Load error:', error);
                alert('Error loading generator: ' + error.message);
            }
        }

        async function transformData() {
            const datasetInput = document.getElementById('transformDataset');
            if (!datasetInput.files[0]) {
                alert('Please select a dataset to transform.');
                return;
            }
            
            const formData = new FormData();
            formData.append('dataset', datasetInput.files[0]);
            
            try {
                const response = await fetch('/transform_data', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to transform data');
                }
                
                console.log('✅ Data transformed successfully');
            } catch (error) {
                console.error('❌ Transform error:', error);
                alert('Error transforming data: ' + error.message);
            }
        }

        function downloadTransformed() {
            if (!transformedData) {
                alert('No transformed data available.');
                return;
            }
            
            // Create and download CSV
            const blob = new Blob([transformedData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'transformed_data.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // File upload handlers
        document.getElementById('dataset').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (file) {
                addLogMessage(`📁 Dataset loaded: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);
                
                const formData = new FormData();
                formData.append('dataset', file);
                
                try {
                    const response = await fetch('/get_columns', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    const targetSelect = document.getElementById('target');
                    targetSelect.innerHTML = '<option value="">Select target column...</option>';
                    
                    data.columns.forEach(col => {
                        const option = document.createElement('option');
                        option.value = col;
                        option.textContent = col;
                        targetSelect.appendChild(option);
                    });
                    
                    addLogMessage(`📊 Detected ${data.columns.length} columns`);
                } catch (error) {
                    console.error('❌ Column detection error:', error);
                    addLogMessage('Error reading dataset columns: ' + error.message);
                }
            }
        });

        // Initialize interface
        document.addEventListener('DOMContentLoaded', function() {
            addLogMessage('🔧 Comprehensive FeatureGenerator UI ready. Select mode and load dataset to begin.');
        });
    </script>
</body>
</html>